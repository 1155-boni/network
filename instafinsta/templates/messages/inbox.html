{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Left column: list of conversations with followed users -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Conversations
                </div>
                <ul class="list-group">
                    {% for convo in conversations %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'messages_with' convo.user.id %}">
                                {{ convo.user.username }}
                            </a>
                            <span>
                                {% if convo.last_message %}
                                    <small class="text-muted">{{ convo.last_message.content|truncatechars:30 }}</small>
                                {% endif %}
                                {% if convo.unread_count > 0 %}
                                    <span class="badge bg-danger">{{ convo.unread_count }}</span>
                                {% endif %}
                            </span>
                        </li>
                    {% empty %}
                        <li class="list-group-item">No followed users yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Right column: chat window -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    {% if receiver %}
                        Chat with <strong>{{ receiver.username }}</strong>
                    {% else %}
                        <em>Select a user to start chatting</em>
                    {% endif %}
                </div>

                <div class="card-body" style="height: 400px; overflow-y: auto;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="mb-3 {% if message.sender == request.user %}text-end{% endif %}">
                                <div class="p-2 rounded 
                                    {% if message.sender == request.user %}
                                        bg-primary text-white
                                    {% else %}
                                        bg-light
                                    {% endif %}
                                    d-inline-block">
                                    <strong>{{ message.sender.username }}:</strong> {{ message.content }}
                                    {% if message.image %}
                                        <br>
                                        <img src="{{ message.image.url }}" class="img-fluid rounded mt-2" alt="Message image" style="max-width: 300px;">
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ message.timestamp|date:"M d, H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No messages yet.</p>
                    {% endif %}
                </div>

                {% if receiver %}
                <div class="card-footer">
                    <form method="post" enctype="multipart/form-data" class="d-flex flex-column">
                        {% csrf_token %}
                        <input type="text" name="content" class="form-control mb-2" placeholder="Type your message..." required>
                        <input type="file" name="image" class="form-control mb-2" accept="image/*">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}