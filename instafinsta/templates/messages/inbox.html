{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Left column: list of conversations -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Conversations
                </div>
                <ul class="list-group list-group-flush">
                    {% for user in users %}
                        {% if user != request.user %}
                        <li class="list-group-item {% if receiver and receiver.id == user.id %}active{% endif %}">
                            <a href="{% url 'messages_with' user.id %}" class="text-decoration-none {% if receiver and receiver.id == user.id %}text-white{% else %}text-dark{% endif %}">
                                {{ user.username }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    {% if not users %}
                        <li class="list-group-item text-muted">No conversations yet.</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Right column: chat window -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    {% if receiver %}
                        Chat with <strong>{{ receiver.username }}</strong>
                    {% else %}
                        <em>Select a user to start chatting</em>
                    {% endif %}
                </div>

                <div class="card-body" style="height: 400px; overflow-y: auto;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="mb-3 {% if message.sender == request.user %}text-end{% endif %}">
                                <div class="p-2 rounded 
                                    {% if message.sender == request.user %}
                                        bg-primary text-white
                                    {% else %}
                                        bg-light
                                    {% endif %}
                                    d-inline-block">
                                    <strong>{{ message.sender.username }}:</strong> {{ message.content }}
                                    <br>
                                    <small class="text-muted">{{ message.timestamp|date:"M d, H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No messages yet.</p>
                    {% endif %}
                </div>

                {% if receiver %}
                <div class="card-footer">
                    <form method="post">
                        {% csrf_token %}
                        {{ form.content }}
                        <button type="submit" class="btn btn-primary btn-sm mt-2">Send</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
