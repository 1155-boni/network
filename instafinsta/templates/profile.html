{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <!-- Profile Card -->
  <div class="instagram-card text-center mb-5">
    <!-- Avatar -->
    {% if profile.avatar %}
    <img src="{{ profile.avatar.url }}" alt="{{ profile.user.username }}'s avatar" class="profile-avatar">
    {% else %}
    <img src="{% static 'images/default-avatar.jpg' %}" alt="Default user avatar" class="profile-avatar">
    {% endif %}

    <!-- Username -->
    <h3 class="fw-bold mb-2">{{ profile.user.username }}</h3>

    <!-- Bio -->
    <p class="text-muted mb-4">
      {% if profile.bio %} {{ profile.bio }} {% else %}
      <em>No bio yet</em> {% endif %}
    </p>

    <!-- Followers / Following -->
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-number" id="followers-count">{{ profile.followers.count }}</div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ profile.following.count }}</div>
        <div class="stat-label">Following</div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="mt-4">
      {% if request.user == profile.user %}
      <a href="{% url 'edit_profile' %}" class="primary-btn me-2">
        <i class="bi bi-pencil-square"></i> Edit Profile
      </a>
      <a href="{% url 'logout' %}" class="outline-btn">
        <i class="bi bi-box-arrow-right"></i> Log Out
      </a>
      {% else %}
        <!-- Follow/Unfollow AJAX button -->
        <button id="follow-btn" class="follow-btn {% if is_following %}danger{% else %}success{% endif %}" data-url="{% url 'follow_toggle' profile.user.username %}">
          {% if is_following %}
            <i class="bi bi-person-dash"></i> Unfollow
          {% else %}
            <i class="bi bi-person-plus"></i> Follow
          {% endif %}
        </button>

        <!-- Message form -->
        <div class="instagram-card mt-4">
          <h5 class="fw-bold mb-3">
            <i class="bi bi-chat-dots"></i> Send a Message
          </h5>
          <form method="post" action="{% url 'send_message' profile.user.id %}">
            {% csrf_token %}
            <div class="input-group">
              <input type="text" name="content" class="form-input rounded-start-pill" placeholder="Write your message..." required>
              <button type="submit" class="primary-btn rounded-end-pill">
                <i class="bi bi-send"></i> Send
              </button>
            </div>
          </form>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- User Posts -->
  <section>
    <h4 class="fw-bold mb-3">Posts</h4>
    {% if posts %}
    <div class="profile-posts-grid">
      {% for post in posts %}
      <div class="profile-post-thumbnail" id="post-{{ post.id }}">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post by {{ profile.user.username }}">
        {% endif %}
        <!-- Overlay for delete if owner -->
        {% if request.user == profile.user %}
        <button type="button" class="btn btn-sm btn-outline-danger delete-post-btn" data-post-id="{{ post.id }}" style="position: absolute; top: 5px; right: 5px;">
          <i class="bi bi-trash"></i>
        </button>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No posts yet.</p>
    {% endif %}
  </section>
</div>

<!-- âœ… AJAX script for follow/unfollow -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const followBtn = document.getElementById("follow-btn");
  if (followBtn) {
    followBtn.addEventListener("click", function () {
      const url = this.dataset.url;

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }

          // Update button text & style
          if (data.action === "followed") {
            followBtn.classList.remove("success");
            followBtn.classList.add("danger");
            followBtn.innerHTML = '<i class="bi bi-person-dash"></i> Unfollow';
          } else {
            followBtn.classList.remove("danger");
            followBtn.classList.add("success");
            followBtn.innerHTML = '<i class="bi bi-person-plus"></i> Follow';
          }

          // Update followers count
          document.getElementById("followers-count").innerText = data.followers_count;
        })
        .catch(error => console.error("Error:", error));
    });
  }
});
</script>
{% endblock %}
