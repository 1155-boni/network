{% extends 'base.html' %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width:700px;">
  <div class="card shadow-lg p-4 text-center" style="border-radius:15px;">

    <h2 class="mb-3">{{ profile.user.username }}'s Profile</h2>

    <!-- Profile Picture -->
    <div class="mb-3">
      {% if profile.profile_pic %}
        <img src="{{ profile.profile_pic.url }}" 
             class="rounded-circle shadow" 
             width="150" height="150" 
             style="object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-light d-flex justify-content-center align-items-center shadow"
             style="width:150px; height:150px; font-size:14px; color:#888;">
          No Photo
        </div>
      {% endif %}
    </div>

    {% if is_owner %}
    <form method="post" enctype="multipart/form-data" class="mb-3">
      {% csrf_token %}
      <input type="file" name="profile_pic" class="form-control mb-2" onchange="this.form.submit();">
    </form>
    {% endif %}

    <div class="text-start mt-3" style="line-height:1.8;">
      <p><strong>Email:</strong> {{ profile.user.email }}</p>
      <p><strong>First Name:</strong> {{ profile.user.first_name }}</p>
      <p><strong>Last Name:</strong> {{ profile.user.last_name }}</p>
      <p><strong>Bio:</strong> {{ profile.bio|default:"No bio yet" }}</p>
      <p><strong>Location:</strong> {{ profile.location|default:"Not set" }}</p>
    </div>

    <div class="d-flex justify-content-around my-4">
      <div><strong>{{ followers_count }}</strong> Followers</div>
      <div><strong>{{ following_count }}</strong> Following</div>
    </div>

    {% if not is_owner %}
      <form action="{% url 'follow_toggle' profile.user.username %}" method="post">
        {% csrf_token %}
        {% if request.user in profile.followers.all %}
          <button type="submit" class="btn btn-danger w-100">Unfollow</button>
        {% else %}
          <button type="submit" class="btn btn-primary w-100">Follow</button>
        {% endif %}
      </form>
    {% endif %}

    {% if is_owner %}
      <a href="{% url 'edit_profile' %}" class="btn btn-primary w-100 mt-2">Edit Profile</a>
    {% endif %}
  </div>

  <!-- User's Posts -->
  <div class="mt-4">
    <h3 class="mb-3">{{ profile.user.username }}'s Posts</h3>

    {% for post in posts %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <p>{{ post.caption }}</p>
        {% if post.image %}
          <img src="{{ post.image.url }}" class="img-fluid rounded mb-2" style="max-height:400px; object-fit:cover;">
        {% endif %}
        <small class="text-muted">{{ post.created_at }}</small>

        <!-- Likes -->
        <form method="post" action="{% url 'toggle_like' post.id %}" class="mt-2">
          {% csrf_token %}
          {% if user in post.likes.all %}
            <button type="submit" class="btn btn-sm btn-danger">Unlike ({{ post.total_likes }})</button>
          {% else %}
            <button type="submit" class="btn btn-sm btn-outline-primary">Like ({{ post.total_likes }})</button>
          {% endif %}
        </form>

        <!-- Comments -->
        <div class="mt-3">
          <h6>Comments ({{ post.comments.count }})</h6>
          {% for comment in post.comments.all %}
            <p><strong>{{ comment.user.username }}:</strong> {{ comment.content }}</p>
          {% empty %}
            <p class="text-muted">No comments yet.</p>
          {% endfor %}

          <form method="post" action="{% url 'add_comment' post.id %}">
            {% csrf_token %}
            <input type="text" name="content" class="form-control" placeholder="Write a comment..." required>
            <button type="submit" class="btn btn-sm btn-primary mt-1">Comment</button>
          </form>
        </div>

        <!-- Delete button only for owner -->
        {% if is_owner %}
        <form method="post" action="{% url 'delete_post' post.id %}" class="mt-2">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger">Delete Post</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% empty %}
      <p class="text-muted">{{ profile.user.username }} has no posts yet.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}
