{% extends 'base.html' %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width:700px;">
  <div class="card shadow-lg p-4 text-center" style="border-radius:15px;">

    <!-- Username -->
    <h2 class="mb-3">{{ profile.user.username }}'s Profile</h2>

    <!-- Profile Picture -->
    <div class="mb-3">
      {% if profile.profile_pic %}
        <img src="{{ profile.profile_pic.url }}" 
             class="rounded-circle shadow" 
             width="150" height="150" 
             style="object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-light d-flex justify-content-center align-items-center shadow"
             style="width:150px; height:150px; font-size:14px; color:#888;">
          No Photo
        </div>
      {% endif %}
    </div>

    <!-- Upload new profile picture -->
    {% if is_owner %}
    <form method="post" enctype="multipart/form-data" class="mb-3">
      {% csrf_token %}
      <input type="file" name="profile_pic" class="form-control mb-2" onchange="this.form.submit();">
    </form>
    {% endif %}

    <!-- Profile Info -->
    <div class="text-start mt-3" style="line-height:1.8;">
      <p><strong>Email:</strong> {{ profile.user.email }}</p>
      <p><strong>First Name:</strong> {{ profile.user.first_name }}</p>
      <p><strong>Last Name:</strong> {{ profile.user.last_name }}</p>
      <p><strong>Bio:</strong> {{ profile.bio|default:"No bio yet" }}</p>
      <p><strong>Location:</strong> {{ profile.location|default:"Not set" }}</p>
    </div>

    <!-- Followers / Following -->
    <div class="d-flex justify-content-around my-4">
      <div><strong>{{ followers_count }}</strong> Followers</div>
      <div><strong>{{ following_count }}</strong> Following</div>
    </div>

    <!-- Follow/Unfollow -->
    {% if not is_owner %}
      <form action="{% url 'follow_toggle' profile.user.username %}" method="post">
        {% csrf_token %}
        {% if request.user in profile.followers.all %}
          <button type="submit" class="btn btn-danger w-100">Unfollow</button>
        {% else %}
          <button type="submit" class="btn btn-primary w-100">Follow</button>
        {% endif %}
      </form>
    {% endif %}

    <!-- Edit Profile Button -->
    {% if is_owner %}
      <a href="{% url 'edit_profile' %}" class="btn btn-primary w-100 mt-2">Edit Profile</a>
    {% endif %}
  </div>

  <!-- User Posts -->
  <div class="mt-4">
    <h4>{{ profile.user.username }}'s Posts</h4>
    {% for post in posts %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <h5>{{ post.caption }}</h5>
          <p class="text-muted">{{ post.content }}</p>

          {% if post.image %}
            <a href="{{ post.image.url }}" target="_blank">
              <img src="{{ post.image.url }}" class="img-fluid rounded mb-2" alt="Post image">
            </a>
          {% endif %}

          <p><strong>{{ post.like_count }}</strong> Likes</p>

          <!-- Like/Unlike -->
          <form method="post" action="{% url 'toggle_like' post.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-primary">
              {% if user in post.likes.all %}
                Unlike
              {% else %}
                Like
              {% endif %}
            </button>
          </form>

          <!-- Timestamp -->
          <small class="text-muted d-block mt-2">
            Posted on {{ post.created_at|date:"M d, Y H:i" }}
          </small>

          <!-- Delete button (only for owner) -->
          {% if is_owner %}
            <form action="{% url 'delete_post' post.id %}" method="post" class="mt-2">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p>No posts yet.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}
