{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <!-- Profile Card -->
  <div class="instagram-card text-center mb-5">
    <!-- Avatar -->
    {% if profile.avatar %}
    <img src="{{ profile.avatar.url }}" alt="{{ user_profile.username }}'s avatar" class="profile-avatar">
    {% else %}
    <img src="{% static 'images/default.jpg' %}" alt="Default user avatar" class="profile-avatar">
    {% endif %}

    <!-- Username -->
    <h3 class="fw-bold mb-2">{{ user_profile.username }}</h3>

    <!-- Bio -->
    <p class="text-muted mb-4">
      {% if profile.bio %} {{ profile.bio }} {% else %}
      <em>No bio yet</em> {% endif %}
    </p>

    <!-- Followers / Following -->
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-number" id="followers-count">{{ followers_count }}</div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ following_count }}</div>
        <div class="stat-label">Following</div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="mt-4">
      {% if not is_owner %}
        <!-- Follow/Unfollow AJAX button -->
        <button id="follow-btn" class="follow-btn {% if request.user in profile.followers.all %}danger{% else %}success{% endif %}" data-url="{% url 'follow_toggle' user_profile.username %}">
          {% if request.user in profile.followers.all %}
            <i class="bi bi-person-dash"></i> Unfollow
          {% else %}
            <i class="bi bi-person-plus"></i> Follow
          {% endif %}
        </button>
      {% endif %}
    </div>
  </div>

  <!-- User Posts -->
  <section>
    <h4 class="fw-bold mb-3">Posts</h4>
    {% if user_profile.post_set.all %}
    <div class="profile-posts-grid">
      {% for post in user_profile.post_set.all %}
      <div class="profile-post-thumbnail">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post by {{ user_profile.username }}">
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No posts yet.</p>
    {% endif %}
  </section>
</div>

<!-- AJAX Script for Follow/Unfollow -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const followBtn = document.getElementById("follow-btn");
    if (followBtn) {
        followBtn.addEventListener("click", function () {
            const url = this.dataset.url;

            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest",
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Update button text & style
                    if (data.action === "followed") {
                        followBtn.classList.remove("success");
                        followBtn.classList.add("danger");
                        followBtn.innerHTML = '<i class="bi bi-person-dash"></i> Unfollow';
                    } else {
                        followBtn.classList.remove("danger");
                        followBtn.classList.add("success");
                        followBtn.innerHTML = '<i class="bi bi-person-plus"></i> Follow';
                    }

                    // Update followers count
                    document.getElementById("followers-count").innerText = data.followers_count;
                })
                .catch(error => console.error("Error:", error));
        });
    }
});
</script>
{% endblock %}